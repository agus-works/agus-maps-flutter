name: Build and Release

on:
  push:
    tags:
      - 'v*'

env:
  COMAPS_TAG: v2025.12.11-2
  FLUTTER_VERSION: '3.27.0'
  NDK_VERSION: '27.2.12479018'
  CMAKE_VERSION: '3.22.1'
  BUILD_TYPE: Release

jobs:
  # ==========================================================================
  # Azure Storage Sanity Test (runs first on free tier)
  # ==========================================================================
  test-azure-storage:
    name: Test Azure Storage Connectivity
    runs-on: ubuntu-latest
    steps:
      - name: Test Azure Blob Storage (Upload/Download/Delete)
        run: |
          echo "=== Azure Blob Storage Sanity Test ==="
          
          # Parse Azure SAS URL into base URL and token
          AZ_URL="${{ secrets.AZ_URL }}"
          if [ -z "$AZ_URL" ]; then
            echo "âŒ ERROR: AZ_URL secret is not set!"
            exit 1
          fi
          
          BASE_URL="${AZ_URL%%\?*}"
          SAS_TOKEN="${AZ_URL#*\?}"
          TEST_FILE="agus/_sanity-test-$(date +%s).txt"
          TEST_URL="${BASE_URL}/${TEST_FILE}?${SAS_TOKEN}"
          
          echo "Base URL: $BASE_URL"
          echo "Test file: $TEST_FILE"
          
          # Create test content
          TEST_CONTENT="Azure Storage Sanity Test - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "$TEST_CONTENT" > /tmp/test-upload.txt
          
          # Step 1: Upload
          echo ""
          echo "ðŸ“¤ Step 1: Testing UPLOAD..."
          UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
            -H "x-ms-blob-type: BlockBlob" \
            -H "Content-Type: text/plain" \
            --data-binary @/tmp/test-upload.txt \
            "$TEST_URL")
          UPLOAD_CODE=$(echo "$UPLOAD_RESPONSE" | tail -1)
          
          if [ "$UPLOAD_CODE" -eq 201 ]; then
            echo "âœ… Upload successful (HTTP $UPLOAD_CODE)"
          else
            echo "âŒ Upload FAILED (HTTP $UPLOAD_CODE)"
            echo "Response: $(echo "$UPLOAD_RESPONSE" | head -n -1)"
            exit 1
          fi
          
          # Step 2: Download
          echo ""
          echo "ðŸ“¥ Step 2: Testing DOWNLOAD..."
          DOWNLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -o /tmp/test-download.txt "$TEST_URL")
          DOWNLOAD_CODE=$(echo "$DOWNLOAD_RESPONSE" | tail -1)
          
          if [ "$DOWNLOAD_CODE" -eq 200 ]; then
            DOWNLOADED_CONTENT=$(cat /tmp/test-download.txt)
            if [ "$DOWNLOADED_CONTENT" = "$TEST_CONTENT" ]; then
              echo "âœ… Download successful and content verified (HTTP $DOWNLOAD_CODE)"
            else
              echo "âš ï¸ Download successful but content mismatch"
              echo "Expected: $TEST_CONTENT"
              echo "Got: $DOWNLOADED_CONTENT"
            fi
          else
            echo "âŒ Download FAILED (HTTP $DOWNLOAD_CODE)"
            exit 1
          fi
          
          # Step 3: Delete
          echo ""
          echo "ðŸ—‘ï¸ Step 3: Testing DELETE..."
          DELETE_RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE "$TEST_URL")
          DELETE_CODE=$(echo "$DELETE_RESPONSE" | tail -1)
          
          if [ "$DELETE_CODE" -eq 202 ]; then
            echo "âœ… Delete successful (HTTP $DELETE_CODE)"
          else
            echo "âš ï¸ Delete returned HTTP $DELETE_CODE (may still be OK)"
          fi
          
          # Step 4: Verify deletion
          echo ""
          echo "ðŸ” Step 4: Verifying deletion..."
          VERIFY_RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null --head "$TEST_URL")
          
          if [ "$VERIFY_RESPONSE" -eq 404 ]; then
            echo "âœ… File confirmed deleted (HTTP 404)"
          else
            echo "âš ï¸ File may still exist (HTTP $VERIFY_RESPONSE)"
          fi
          
          echo ""
          echo "=== Azure Storage Sanity Test PASSED ==="
          echo "âœ… All operations successful - ready to proceed with builds"

  # ==========================================================================
  # macOS Job: Builds iOS and macOS
  # ==========================================================================
  build-and-release-mac-platforms:
    name: Build iOS and macOS
    needs: test-azure-storage
    # Toggle: set to 'true' to run macOS, 'false' to skip (saves cost)
    if: false
    runs-on: macos-14-xlarge
    permissions:
      contents: write
    steps:
      # ======================================================================
      # Setup
      # ======================================================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      # ======================================================================
      # CoMaps Source Cache (Azure Blob Storage)
      # ======================================================================
      - name: Check CoMaps Cache
        id: comaps-cache
        run: |
          # Parse Azure SAS URL into base URL and token
          AZ_URL="${{ secrets.AZ_URL }}"
          BASE_URL="${AZ_URL%%\?*}"
          SAS_TOKEN="${AZ_URL#*\?}"
          CACHE_FILE="agus/agus-comaps-mac-${{ env.COMAPS_TAG }}.tar.gz"
          CACHE_URL="${BASE_URL}/${CACHE_FILE}?${SAS_TOKEN}"
          
          echo "Checking for cache: ${BASE_URL}/${CACHE_FILE}"
          if curl -sf --head "$CACHE_URL" > /dev/null 2>&1; then
            echo "âœ“ Cache found!"
            echo "cache-hit=true" >> $GITHUB_OUTPUT
          else
            echo "âœ— Cache not found, will clone from git"
            echo "cache-hit=false" >> $GITHUB_OUTPUT
          fi
          echo "cache-url=$CACHE_URL" >> $GITHUB_OUTPUT

      - name: Download CoMaps from Cache
        if: steps.comaps-cache.outputs.cache-hit == 'true'
        run: |
          echo "Downloading CoMaps from Azure Blob Storage cache..."
          mkdir -p thirdparty
          curl -fL "${{ steps.comaps-cache.outputs.cache-url }}" | tar -xz -C thirdparty
          echo "âœ“ CoMaps restored from cache ($(du -sh thirdparty/comaps | cut -f1))"

      - name: Clone CoMaps (Cache Miss)
        id: clone-comaps
        if: steps.comaps-cache.outputs.cache-hit != 'true'
        run: |
          echo "Cloning CoMaps with recursive submodules (this takes ~5-10 min)..."
          mkdir -p thirdparty
          git clone https://github.com/comaps/comaps.git thirdparty/comaps
          cd thirdparty/comaps
          git fetch --tags --prune
          git checkout --detach ${{ env.COMAPS_TAG }}
          git submodule update --init --recursive
          cd ../..
          echo "âœ“ Clone complete ($(du -sh thirdparty/comaps | cut -f1))"
          echo "cloned=true" >> $GITHUB_OUTPUT

      - name: Upload CoMaps to Cache
        if: steps.clone-comaps.outputs.cloned == 'true'
        run: |
          echo "Uploading pristine CoMaps to Azure Blob Storage cache..."
          
          # Install azcopy
          echo "Installing azcopy..."
          curl -fsSL https://aka.ms/downloadazcopy-v10-mac -o /tmp/azcopy.zip
          unzip -q /tmp/azcopy.zip -d /tmp/azcopy
          AZCOPY=$(find /tmp/azcopy -name 'azcopy' -type f | head -1)
          chmod +x "$AZCOPY"
          
          # Compress
          if command -v pigz &> /dev/null; then
            tar -c -C thirdparty comaps | pigz -1 > /tmp/comaps-cache.tar.gz
          else
            tar -cz -C thirdparty comaps > /tmp/comaps-cache.tar.gz
          fi
          CACHE_SIZE=$(du -h /tmp/comaps-cache.tar.gz | cut -f1)
          echo "Cache archive size: $CACHE_SIZE"
          
          # Upload
          "$AZCOPY" copy /tmp/comaps-cache.tar.gz "${{ steps.comaps-cache.outputs.cache-url }}" \
            --blob-type BlockBlob \
            --overwrite=true
          
          rm /tmp/comaps-cache.tar.gz
          echo "âœ“ Cache uploaded successfully ($CACHE_SIZE)"

      - name: Install Build Dependencies
        run: |
          brew install ninja || true
          # macOS 14 uses PEP 668 externally-managed Python, use venv
          python3 -m venv $HOME/.protobuf-venv
          source $HOME/.protobuf-venv/bin/activate
          pip install --upgrade pip
          pip install 'protobuf<4.0'
          # Add venv to PATH for subsequent steps
          echo "$HOME/.protobuf-venv/bin" >> $GITHUB_PATH

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      # ======================================================================
      # Bootstrap CoMaps (shared for all platforms)
      # ======================================================================
      - name: Bootstrap CoMaps
        run: |
          chmod +x scripts/bootstrap.sh
          ./scripts/bootstrap.sh --no-cache

      # ======================================================================
      # Bundle Headers (for caching/release)
      # ======================================================================
      - name: Bundle Headers
        run: |
          chmod +x scripts/bundle_headers.sh
          ./scripts/bundle_headers.sh
          ls -lh build/agus-headers.tar.gz

      - name: Upload Headers Artifact
        uses: actions/upload-artifact@v4
        with:
          name: agus-headers
          path: build/agus-headers.tar.gz

      # ======================================================================
      # Build iOS XCFramework
      # ======================================================================
      - name: Build iOS XCFramework
        run: |
          chmod +x scripts/build_binaries_ios.sh
          ./scripts/build_binaries_ios.sh
          ls -la build/agus-binaries-ios/

      - name: Create iOS Binaries Archive
        run: |
          cd build/agus-binaries-ios
          zip -r ../agus-binaries-ios.zip CoMaps.xcframework
          ls -lh ../agus-binaries-ios.zip

      - name: Upload iOS Binaries Artifact
        uses: actions/upload-artifact@v4
        with:
          name: agus-binaries-ios
          path: build/agus-binaries-ios.zip

      # ======================================================================
      # Build macOS XCFramework
      # ======================================================================
      - name: Build macOS XCFramework
        run: |
          chmod +x scripts/build_binaries_macos.sh
          ./scripts/build_binaries_macos.sh
          ls -la build/agus-binaries-macos/

      - name: Create macOS Binaries Archive
        run: |
          cd build/agus-binaries-macos
          zip -r ../agus-binaries-macos.zip CoMaps.xcframework
          ls -lh ../agus-binaries-macos.zip

      - name: Upload macOS Binaries Artifact
        uses: actions/upload-artifact@v4
        with:
          name: agus-binaries-macos
          path: build/agus-binaries-macos.zip

      # ======================================================================
      # Build iOS Example App (Simulator)
      # ======================================================================
      - name: Setup iOS Pre-built XCFramework
        run: |
          mkdir -p ios/Frameworks
          cp -r build/agus-binaries-ios/CoMaps.xcframework ios/Frameworks/
          ls -la ios/Frameworks/

      - name: Precache iOS
        run: flutter precache --ios

      - name: Install iOS CocoaPods Dependencies
        run: |
          cd example/ios
          pod install

      - name: Build iOS Simulator App
        run: |
          cd example
          flutter build ios --simulator --debug \
            --build-name=1.0.0 \
            --build-number=${{ github.run_number }}

      - name: Prepare iOS Artifact
        run: |
          cd example/build/ios/iphonesimulator
          zip -r ../../../../artifacts/agus-maps-ios-simulator.app.zip Runner.app
          ls -lh ../../../../artifacts/

      - name: Upload iOS App Artifact
        uses: actions/upload-artifact@v4
        with:
          name: agus-maps-ios-simulator
          path: artifacts/agus-maps-ios-simulator.app.zip

      # ======================================================================
      # Build macOS Example App
      # ======================================================================
      - name: Setup macOS Pre-built XCFramework
        run: |
          mkdir -p macos/Frameworks
          cp -r build/agus-binaries-macos/CoMaps.xcframework macos/Frameworks/
          ls -la macos/Frameworks/

      - name: Precache macOS
        run: flutter precache --macos

      - name: Install macOS CocoaPods Dependencies
        run: |
          cd example/macos
          pod install

      - name: Build macOS Release App
        run: |
          cd example
          flutter build macos --release \
            --build-name=1.0.0 \
            --build-number=${{ github.run_number }}

      - name: Prepare macOS Artifact
        run: |
          cd example/build/macos/Build/Products/Release
          zip -r ../../../../../../artifacts/agus-maps-macos.app.zip agus_maps_flutter_example.app
          ls -lh ../../../../../../artifacts/

      - name: Upload macOS App Artifact
        uses: actions/upload-artifact@v4
        with:
          name: agus-maps-macos
          path: artifacts/agus-maps-macos.app.zip

  # ==========================================================================
  # Windows Job: Builds Windows
  # ==========================================================================
  build-and-release-windows-platform:
    name: Build Windows
    needs: test-azure-storage
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      # ======================================================================
      # Setup
      # ======================================================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      # ======================================================================
      # CoMaps Source Cache (Azure Blob Storage)
      # ======================================================================
      - name: Check CoMaps Cache
        id: comaps-cache
        run: |
          # Parse Azure SAS URL into base URL and token
          $azUrl = "${{ secrets.AZ_URL }}"
          $baseUrl = $azUrl -replace '\?.*$', ''
          $sasToken = $azUrl -replace '^[^?]*\?', ''
          $cacheFile = "agus/agus-comaps-win-${{ env.COMAPS_TAG }}.zip"
          $cacheUrl = "${baseUrl}/${cacheFile}?${sasToken}"
          
          Write-Host "Checking for cache: ${baseUrl}/${cacheFile}"
          try {
            $response = Invoke-WebRequest -Uri $cacheUrl -Method Head -UseBasicParsing -ErrorAction Stop
            Write-Host "âœ“ Cache found!"
            "cache-hit=true" >> $env:GITHUB_OUTPUT
          } catch {
            Write-Host "âœ— Cache not found, will clone from git"
            "cache-hit=false" >> $env:GITHUB_OUTPUT
          }
          "cache-url=$cacheUrl" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Download CoMaps from Cache
        if: steps.comaps-cache.outputs.cache-hit == 'true'
        run: |
          Write-Host "Downloading CoMaps from Azure Blob Storage cache..."
          New-Item -ItemType Directory -Force -Path thirdparty | Out-Null
          $cacheUrl = "${{ steps.comaps-cache.outputs.cache-url }}"
          $tempZip = "$env:TEMP\comaps-cache.zip"
          
          Invoke-WebRequest -Uri $cacheUrl -OutFile $tempZip -UseBasicParsing
          Expand-Archive -Path $tempZip -DestinationPath thirdparty -Force
          Remove-Item $tempZip
          
          $size = "{0:N2}" -f ((Get-ChildItem -Path thirdparty\comaps -Recurse | Measure-Object -Property Length -Sum).Sum / 1GB)
          Write-Host "âœ“ CoMaps restored from cache (${size} GB)"
        shell: pwsh

      - name: Clone CoMaps (Cache Miss)
        id: clone-comaps
        if: steps.comaps-cache.outputs.cache-hit != 'true'
        run: |
          Write-Host "Cloning CoMaps with recursive submodules (this takes ~5-10 min)..."
          New-Item -ItemType Directory -Force -Path thirdparty | Out-Null
          # Clone from comaps/comaps repository (not organicmaps)
          git clone https://github.com/comaps/comaps.git thirdparty/comaps
          Push-Location thirdparty/comaps
          git fetch --tags --prune
          git checkout --detach ${{ env.COMAPS_TAG }}
          git submodule update --init --recursive
          Pop-Location
          
          $size = "{0:N2}" -f ((Get-ChildItem -Path thirdparty\comaps -Recurse | Measure-Object -Property Length -Sum).Sum / 1GB)
          Write-Host "âœ“ Clone complete (${size} GB)"
          "cloned=true" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Upload CoMaps to Cache
        if: steps.clone-comaps.outputs.cloned == 'true'
        run: |
          Write-Host "Uploading pristine CoMaps to Azure Blob Storage cache..."
          
          # Verify required tools are available
          if (-not (Get-Command 7z -ErrorAction SilentlyContinue)) {
            Write-Error "7z not found! Expected to be pre-installed on Windows runners."
            exit 1
          }
          if (-not (Get-Command azcopy -ErrorAction SilentlyContinue)) {
            Write-Error "azcopy not found! Expected to be pre-installed on Windows runners."
            exit 1
          }
          
          # Use 7zip for faster compression (pre-installed on Windows runners)
          $tempZip = "$env:TEMP\comaps-cache.zip"
          Write-Host "Compressing with 7zip (fast mode)..."
          & 7z a -tzip -mx=1 -mmt=on $tempZip .\thirdparty\comaps\* | Out-Null
          
          $cacheSize = "{0:N2}" -f ((Get-Item $tempZip).Length / 1MB)
          Write-Host "Cache archive size: ${cacheSize} MB"
          
          # Use azcopy for large file uploads (pre-installed on Windows runners)
          # Handles chunked transfer for multi-GB files
          $cacheUrl = "${{ steps.comaps-cache.outputs.cache-url }}"
          Write-Host "Uploading with azcopy (chunked transfer)..."
          azcopy copy $tempZip $cacheUrl --blob-type BlockBlob --overwrite=true
          
          Remove-Item $tempZip
          Write-Host "âœ“ Cache uploaded successfully (${cacheSize} MB)"
        shell: pwsh

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: C:\vcpkg
          key: vcpkg-windows-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-windows-

      - name: Setup vcpkg
        run: |
          if (-not (Test-Path "C:\vcpkg\vcpkg.exe")) {
            git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
            C:\vcpkg\bootstrap-vcpkg.bat
          }
          # Install zlib for Windows build (--classic bypasses manifest mode)
          C:\vcpkg\vcpkg.exe install zlib:x64-windows --classic
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      # ======================================================================
      # Bootstrap CoMaps
      # ======================================================================
      - name: Bootstrap CoMaps
        run: |
          .\scripts\bootstrap.ps1 -NoCache
        shell: pwsh

      # ======================================================================
      # Build Windows Native Libraries
      # ======================================================================
      - name: Build Windows Native Libraries
        run: |
          # Remove Strawberry Perl from PATH to prevent ccache conflicts
          $env:PATH = ($env:PATH -split ';' | Where-Object { $_ -notlike '*Strawberry*' }) -join ';'
          .\scripts\build_binaries_windows.ps1 -VcpkgRoot "C:\vcpkg"
          Get-ChildItem -Path build\agus-binaries-windows\ -Recurse
        shell: pwsh

      - name: Upload Windows Binaries Artifact
        uses: actions/upload-artifact@v4
        with:
          name: agus-binaries-windows
          path: build/agus-binaries-windows.zip

      # ======================================================================
      # Build Windows Example App
      # ======================================================================
      - name: Setup Windows Pre-built DLLs
        run: |
          New-Item -ItemType Directory -Force -Path windows\prebuilt\x64
          Copy-Item -Path build\agus-binaries-windows\x64\* -Destination windows\prebuilt\x64\ -Force
          Get-ChildItem -Path windows\prebuilt\ -Recurse
        shell: pwsh

      - name: Get Flutter Dependencies
        run: |
          flutter pub get
          cd example
          flutter pub get

      - name: Download Base MWM Files
        run: |
          # Download base MWM files required for the example app
          $assetsDir = "example\assets\maps"
          New-Item -ItemType Directory -Force -Path $assetsDir | Out-Null
          
          # Mirror and snapshot
          $mirror = "https://omaps.wfr.software/maps/"
          
          # Fetch latest snapshot version from mirror listing
          $html = Invoke-WebRequest -Uri $mirror -UseBasicParsing
          $snapshots = [regex]::Matches($html.Content, 'href="\.?/?([0-9]{6})/"') | ForEach-Object { $_.Groups[1].Value } | Sort-Object -Descending
          $snapshot = $snapshots[0]
          Write-Host "Using snapshot: $snapshot"
          
          # Base MWM files to download
          $files = @("World.mwm", "WorldCoasts.mwm", "Gibraltar.mwm")
          
          foreach ($file in $files) {
            $url = "${mirror}${snapshot}/${file}"
            $output = Join-Path $assetsDir $file
            Write-Host "Downloading: $url"
            Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
            Write-Host "  -> $output ($('{0:N2}' -f ((Get-Item $output).Length / 1MB)) MB)"
          }
          
          # Copy ICU data file from CoMaps (required for internationalization)
          $icuSource = "thirdparty\comaps\data\icudt75l.dat"
          $icuDest = Join-Path $assetsDir "icudt75l.dat"
          if (Test-Path $icuSource) {
            Copy-Item -Path $icuSource -Destination $icuDest
            Write-Host "Copied ICU data: $icuDest ($('{0:N2}' -f ((Get-Item $icuDest).Length / 1MB)) MB)"
          } else {
            Write-Error "ICU data file not found: $icuSource"
            exit 1
          }
          
          Get-ChildItem -Path $assetsDir
        shell: pwsh

      - name: Build Windows Release App
        run: |
          cd example
          flutter build windows --release `
            --build-name=1.0.0 `
            --build-number=${{ github.run_number }}
        shell: pwsh

      - name: Prepare Windows Artifacts
        run: |
          New-Item -ItemType Directory -Force -Path artifacts
          $releasePath = "example\build\windows\x64\runner\Release"
          Compress-Archive -Path "$releasePath\*" -DestinationPath "artifacts\agus-maps-windows.zip" -Force
          Get-ChildItem -Path artifacts\
        shell: pwsh

      - name: Upload Windows App Artifact
        uses: actions/upload-artifact@v4
        with:
          name: agus-maps-windows
          path: artifacts/agus-maps-windows.zip

  # ==========================================================================
  # Android Job: Builds Android (runs on Windows Host)
  # ==========================================================================
  build-and-release-android-platform:
    name: Build Android (Windows Host)
    needs: test-azure-storage
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      # ======================================================================
      # Setup
      # ======================================================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      # ======================================================================
      # CoMaps Source Cache (Shared with Windows Job)
      # ======================================================================
      - name: Check CoMaps Cache
        id: comaps-cache
        run: |
          # Parse Azure SAS URL into base URL and token
          $azUrl = "${{ secrets.AZ_URL }}"
          $baseUrl = $azUrl -replace '\?.*$', ''
          $sasToken = $azUrl -replace '^[^?]*\?', ''
          $cacheFile = "agus/agus-comaps-win-${{ env.COMAPS_TAG }}.zip"
          $cacheUrl = "${baseUrl}/${cacheFile}?${sasToken}"
          
          Write-Host "Checking for cache: ${baseUrl}/${cacheFile}"
          try {
            $response = Invoke-WebRequest -Uri $cacheUrl -Method Head -UseBasicParsing -ErrorAction Stop
            Write-Host "âœ“ Cache found!"
            "cache-hit=true" >> $env:GITHUB_OUTPUT
          } catch {
            Write-Host "âœ— Cache not found, will clone from git"
            "cache-hit=false" >> $env:GITHUB_OUTPUT
          }
          "cache-url=$cacheUrl" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Download CoMaps from Cache
        if: steps.comaps-cache.outputs.cache-hit == 'true'
        run: |
          Write-Host "Downloading CoMaps from Azure Blob Storage cache..."
          New-Item -ItemType Directory -Force -Path thirdparty | Out-Null
          $cacheUrl = "${{ steps.comaps-cache.outputs.cache-url }}"
          $tempZip = "$env:TEMP\comaps-cache.zip"
          
          Invoke-WebRequest -Uri $cacheUrl -OutFile $tempZip -UseBasicParsing
          Expand-Archive -Path $tempZip -DestinationPath thirdparty -Force
          Remove-Item $tempZip
          
          $size = "{0:N2}" -f ((Get-ChildItem -Path thirdparty\comaps -Recurse | Measure-Object -Property Length -Sum).Sum / 1GB)
          Write-Host "âœ“ CoMaps restored from cache (${size} GB)"
        shell: pwsh

      - name: Clone CoMaps (Cache Miss)
        id: clone-comaps
        if: steps.comaps-cache.outputs.cache-hit != 'true'
        run: |
          Write-Host "Cloning CoMaps with recursive submodules (this takes ~5-10 min)..."
          New-Item -ItemType Directory -Force -Path thirdparty | Out-Null
          # Clone from comaps/comaps repository (not organicmaps)
          git clone https://github.com/comaps/comaps.git thirdparty/comaps
          Push-Location thirdparty/comaps
          git fetch --tags --prune
          git checkout --detach ${{ env.COMAPS_TAG }}
          git submodule update --init --recursive
          Pop-Location
          
          $size = "{0:N2}" -f ((Get-ChildItem -Path thirdparty\comaps -Recurse | Measure-Object -Property Length -Sum).Sum / 1GB)
          Write-Host "âœ“ Clone complete (${size} GB)"
          "cloned=true" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Upload CoMaps to Cache
        if: steps.clone-comaps.outputs.cloned == 'true'
        run: |
          Write-Host "Uploading pristine CoMaps to Azure Blob Storage cache..."
          
          if (-not (Get-Command 7z -ErrorAction SilentlyContinue)) {
            Write-Error "7z not found! Expected to be pre-installed on Windows runners."
            exit 1
          }
          if (-not (Get-Command azcopy -ErrorAction SilentlyContinue)) {
            Write-Error "azcopy not found! Expected to be pre-installed on Windows runners."
            exit 1
          }
          
          $tempZip = "$env:TEMP\comaps-cache.zip"
          Write-Host "Compressing with 7zip (fast mode)..."
          & 7z a -tzip -mx=1 -mmt=on $tempZip .\thirdparty\comaps\* | Out-Null
          
          $cacheSize = "{0:N2}" -f ((Get-Item $tempZip).Length / 1MB)
          Write-Host "Cache archive size: ${cacheSize} MB"
          
          $cacheUrl = "${{ steps.comaps-cache.outputs.cache-url }}"
          Write-Host "Uploading with azcopy (chunked transfer)..."
          azcopy copy $tempZip $cacheUrl --blob-type BlockBlob --overwrite=true
          
          Remove-Item $tempZip
          Write-Host "âœ“ Cache uploaded successfully (${cacheSize} MB)"
        shell: pwsh

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK and CMake
        run: |
          echo "y" | sdkmanager --licenses > $null
          sdkmanager "ndk;${{ env.NDK_VERSION }}" "cmake;${{ env.CMAKE_VERSION }}"
          echo "ANDROID_NDK_HOME=$env:ANDROID_HOME\ndk\${{ env.NDK_VERSION }}" >> $env:GITHUB_ENV
          echo "NDK_HOME=$env:ANDROID_HOME\ndk\${{ env.NDK_VERSION }}" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      # ======================================================================
      # Bootstrap CoMaps
      # ======================================================================
      - name: Bootstrap CoMaps
        run: |
          .\scripts\bootstrap.ps1 -NoCache
        shell: pwsh

      # ======================================================================
      # Build Android Native Libraries
      # ======================================================================
      - name: Build Android Native Libraries
        run: |
          .\scripts\build_binaries_android.ps1
          Get-ChildItem -Path build\agus-binaries-android\ -Recurse
        shell: pwsh

      - name: Upload Android Binaries Artifact
        uses: actions/upload-artifact@v4
        with:
          name: agus-binaries-android
          path: build/agus-binaries-android.zip

      # ======================================================================
      # Build Android Example App
      # ======================================================================
      - name: Setup Android Pre-built Binaries
        run: |
          New-Item -ItemType Directory -Force -Path android\prebuilt | Out-Null
          Get-ChildItem -Path build\agus-binaries-android\* | Copy-Item -Destination android\prebuilt\ -Force -Recurse
          Get-ChildItem -Path android\prebuilt\ -Recurse
        shell: pwsh

      - name: Get Flutter Dependencies
        run: |
          flutter pub get
          cd example
          flutter pub get

      - name: Download Base MWM Files (Required for Assets)
        run: |
          # Download base MWM files required for the example app assets
          $assetsDir = "example\assets\maps"
          New-Item -ItemType Directory -Force -Path $assetsDir | Out-Null
          
          # Mirror and snapshot
          $mirror = "https://omaps.wfr.software/maps/"
          
          # Fetch latest snapshot version from mirror listing
          $html = Invoke-WebRequest -Uri $mirror -UseBasicParsing
          $snapshots = [regex]::Matches($html.Content, 'href="\.?/?([0-9]{6})/"') | ForEach-Object { $_.Groups[1].Value } | Sort-Object -Descending
          $snapshot = $snapshots[0]
          Write-Host "Using snapshot: $snapshot"
          
          # Base MWM files to download
          $files = @("World.mwm", "WorldCoasts.mwm", "Gibraltar.mwm")
          
          foreach ($file in $files) {
            $url = "${mirror}${snapshot}/${file}"
            $output = Join-Path $assetsDir $file
            Write-Host "Downloading: $url"
            Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
            Write-Host "  -> $output ($('{0:N2}' -f ((Get-Item $output).Length / 1MB)) MB)"
          }
          
          # Copy ICU data file from CoMaps (required for internationalization)
          $icuSource = "thirdparty\comaps\data\icudt75l.dat"
          $icuDest = Join-Path $assetsDir "icudt75l.dat"
          if (Test-Path $icuSource) {
            Copy-Item -Path $icuSource -Destination $icuDest
            Write-Host "Copied ICU data: $icuDest ($('{0:N2}' -f ((Get-Item $icuDest).Length / 1MB)) MB)"
          } else {
            Write-Error "ICU data file not found: $icuSource"
            exit 1
          }
        shell: pwsh

      - name: Build Android App Bundle (AAB)
        run: |
          cd example
          flutter build appbundle --release `
            --build-name=1.0.0 `
            --build-number=${{ github.run_number }}
        shell: pwsh

      - name: Build Android APK
        run: |
          cd example
          flutter build apk --release `
            --build-name=1.0.0 `
            --build-number=${{ github.run_number }}
        shell: pwsh

      - name: Prepare Android Artifacts
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          Copy-Item -Path example\build\app\outputs\bundle\release\app-release.aab -Destination artifacts\agus-maps-android.aab
          Copy-Item -Path example\build\app\outputs\flutter-apk\app-release.apk -Destination artifacts\agus-maps-android.apk
          Get-ChildItem -Path artifacts\
        shell: pwsh

      - name: Upload Android App Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agus-maps-android
          path: artifacts/*

  # ==========================================================================
  # Release Job: Aggregates artifacts from all jobs
  # ==========================================================================
  release:
    name: Create Release
    needs: [build-and-release-mac-platforms, build-and-release-windows-platform, build-and-release-android-platform]
    # Run even if some dependencies partially failed or were skipped
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          merge-multiple: true

      - name: Prepare Final Assets
        run: |
          mkdir -p final-assets
          
          # Move artifacts if they exist
          [ -f all-artifacts/agus-headers.tar.gz ] && cp all-artifacts/agus-headers.tar.gz final-assets/ || true
          [ -f all-artifacts/agus-binaries-android.zip ] && cp all-artifacts/agus-binaries-android.zip final-assets/ || true
          [ -f all-artifacts/agus-binaries-ios.zip ] && cp all-artifacts/agus-binaries-ios.zip final-assets/ || true
          [ -f all-artifacts/agus-binaries-macos.zip ] && cp all-artifacts/agus-binaries-macos.zip final-assets/ || true
          [ -f all-artifacts/agus-binaries-windows.zip ] && cp all-artifacts/agus-binaries-windows.zip final-assets/ || true
          
          [ -f all-artifacts/agus-maps-android.aab ] && cp all-artifacts/agus-maps-android.aab final-assets/ || true
          [ -f all-artifacts/agus-maps-android.apk ] && cp all-artifacts/agus-maps-android.apk final-assets/ || true
          [ -f all-artifacts/agus-maps-ios-simulator.app.zip ] && cp all-artifacts/agus-maps-ios-simulator.app.zip final-assets/ || true
          [ -f all-artifacts/agus-maps-macos.app.zip ] && cp all-artifacts/agus-maps-macos.app.zip final-assets/ || true
          [ -f all-artifacts/agus-maps-windows.zip ] && cp all-artifacts/agus-maps-windows.zip final-assets/ || true

          # Generate build info
          cat > final-assets/BUILD_INFO.txt << EOF
          Agus Maps Flutter - ${{ github.ref_name }}
          ==================================
          
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Build Number: ${{ github.run_number }}
          Git SHA: ${{ github.sha }}
          Git Tag: ${{ github.ref_name }}
          
          Flutter Version: ${{ env.FLUTTER_VERSION }}
          CoMaps Version: ${{ env.COMAPS_TAG }}
          
          Supported Platforms:
          - Android (armeabi-v7a, arm64-v8a, x86_64)
          - iOS (Simulator)
          - macOS (arm64 + x86_64 universal)
          - Windows (x64)
          EOF
          
          echo "=== Final assets collected ==="
          ls -lh final-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Agus Maps ${{ github.ref_name }}
          body: |
            ## Agus Maps Flutter - ${{ github.ref_name }}
            
            Offline vector maps for Flutter powered by the CoMaps engine.
            
            ðŸ“– **[Full Installation Guide](https://github.com/agus-works/agus-maps-flutter/blob/main/docs/RELEASE.md)**
            
            ---
            
            ### Quick Start
            
            #### Android
            ```bash
            # Install APK
            adb install agus-maps-android.apk
            ```
            
            #### Windows
            ```powershell
            Expand-Archive agus-maps-windows.zip -DestinationPath .
            .\agus_maps_flutter_example.exe
            ```
            
            #### macOS
            ```bash
            unzip agus-maps-macos.app.zip
            xattr -cr agus_maps_flutter_example.app
            open agus_maps_flutter_example.app
            ```
            
            ---
            
            ### Downloads
            
            #### ðŸ“± Example Apps
            | Platform | File | Description |
            |----------|------|-------------|
            | Android | `agus-maps-android.apk` | Universal APK |
            | Android | `agus-maps-android.aab` | App Bundle |
            | Windows | `agus-maps-windows.zip` | x64 Release |
            | macOS | `agus-maps-macos.app.zip` | Universal Release |
            | iOS | `agus-maps-ios-simulator.app.zip` | Simulator Debug |
            
            #### ðŸ“¦ Native Libraries
            | Platform | File | Description |
            |----------|------|-------------|
            | Headers | `agus-headers.tar.gz` | C++ Headers |
            | Android | `agus-binaries-android.zip` | .so libs |
            | iOS | `agus-binaries-ios.zip` | XCFramework |
            | macOS | `agus-binaries-macos.zip` | XCFramework |
            | Windows | `agus-binaries-windows.zip` | DLLs |
            
            ---
            
            ### Build Info
            - Build Number: ${{ github.run_number }}
            - Flutter: ${{ env.FLUTTER_VERSION }}
            - CoMaps: ${{ env.COMAPS_TAG }}
          draft: false
          prerelease: false
          files: |
            final-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
