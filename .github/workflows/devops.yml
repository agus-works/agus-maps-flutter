name: Build and Release

on:
  push:
    tags:
      - 'v*'

env:
  COMAPS_TAG: v2025.12.11-2
  FLUTTER_VERSION: '3.27.0'
  NDK_VERSION: '27.2.12479018'
  CMAKE_VERSION: '3.22.1'
  BUILD_TYPE: Release

jobs:
  # ==========================================================================
  # macOS Job: Builds Headers, Android, iOS, macOS (all in one job)
  # ==========================================================================
  build-mac-platforms:
    name: Build Android, iOS, macOS
    # Toggle: set to 'true' to run macOS, 'false' to skip (saves cost)
    if: true
    runs-on: macos-14-xlarge
    permissions:
      contents: write
    steps:
      # ======================================================================
      # Setup
      # ======================================================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Cache CoMaps Source
        id: cache-comaps
        uses: actions/cache@v4
        with:
          path: thirdparty/comaps
          key: comaps-source-${{ runner.os }}-${{ env.COMAPS_TAG }}
          restore-keys: |
            comaps-source-${{ runner.os }}-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK and CMake
        run: |
          echo "y" | sdkmanager --licenses > /dev/null 2>&1 || true
          sdkmanager "ndk;${{ env.NDK_VERSION }}" "cmake;${{ env.CMAKE_VERSION }}"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_HOME/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV

      - name: Install Build Dependencies
        run: |
          brew install ninja || true
          # macOS 14 uses PEP 668 externally-managed Python, use venv
          python3 -m venv $HOME/.protobuf-venv
          source $HOME/.protobuf-venv/bin/activate
          pip install --upgrade pip
          pip install 'protobuf<4.0'
          # Add venv to PATH for subsequent steps
          echo "$HOME/.protobuf-venv/bin" >> $GITHUB_PATH

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      # ======================================================================
      # Bootstrap CoMaps (shared for all platforms)
      # ======================================================================
      - name: Bootstrap CoMaps
        run: |
          chmod +x scripts/bootstrap.sh
          ./scripts/bootstrap.sh --no-cache

      # ======================================================================
      # Bundle Headers (for caching/release)
      # ======================================================================
      - name: Bundle Headers
        run: |
          chmod +x scripts/bundle_headers.sh
          ./scripts/bundle_headers.sh
          ls -lh build/agus-headers.tar.gz

      # ======================================================================
      # Build Android Native Libraries
      # ======================================================================
      - name: Build Android Native Libraries
        run: |
          chmod +x scripts/build_binaries_android.sh
          ./scripts/build_binaries_android.sh
          ls -la build/agus-binaries-android/

      # ======================================================================
      # Build iOS XCFramework
      # ======================================================================
      - name: Build iOS XCFramework
        run: |
          chmod +x scripts/build_binaries_ios.sh
          ./scripts/build_binaries_ios.sh
          ls -la build/agus-binaries-ios/

      - name: Create iOS Binaries Archive
        run: |
          cd build/agus-binaries-ios
          zip -r ../agus-binaries-ios.zip CoMaps.xcframework
          ls -lh ../agus-binaries-ios.zip

      # ======================================================================
      # Build macOS XCFramework
      # ======================================================================
      - name: Build macOS XCFramework
        run: |
          chmod +x scripts/build_binaries_macos.sh
          ./scripts/build_binaries_macos.sh
          ls -la build/agus-binaries-macos/

      - name: Create macOS Binaries Archive
        run: |
          cd build/agus-binaries-macos
          zip -r ../agus-binaries-macos.zip CoMaps.xcframework
          ls -lh ../agus-binaries-macos.zip

      # ======================================================================
      # Build Android Example App
      # ======================================================================
      - name: Setup Android Pre-built Binaries
        run: |
          mkdir -p android/prebuilt
          cp -r build/agus-binaries-android/* android/prebuilt/
          ls -la android/prebuilt/

      - name: Get Flutter Dependencies
        run: |
          flutter pub get
          cd example && flutter pub get

      - name: Build Android App Bundle (AAB)
        run: |
          cd example
          flutter build appbundle --release \
            --build-name=1.0.0 \
            --build-number=${{ github.run_number }}

      - name: Build Android APK
        run: |
          cd example
          flutter build apk --release \
            --build-name=1.0.0 \
            --build-number=${{ github.run_number }}

      - name: Prepare Android Artifacts
        run: |
          mkdir -p artifacts
          cp example/build/app/outputs/bundle/release/app-release.aab artifacts/agus-maps-android.aab
          cp example/build/app/outputs/flutter-apk/app-release.apk artifacts/agus-maps-android.apk
          ls -lh artifacts/

      # ======================================================================
      # Build iOS Example App (Simulator)
      # ======================================================================
      - name: Setup iOS Pre-built XCFramework
        run: |
          mkdir -p ios/Frameworks
          cp -r build/agus-binaries-ios/CoMaps.xcframework ios/Frameworks/
          ls -la ios/Frameworks/

      - name: Precache iOS
        run: flutter precache --ios

      - name: Install iOS CocoaPods Dependencies
        run: |
          cd example/ios
          pod install

      - name: Build iOS Simulator App
        run: |
          cd example
          flutter build ios --simulator --debug \
            --build-name=1.0.0 \
            --build-number=${{ github.run_number }}

      - name: Prepare iOS Artifact
        run: |
          cd example/build/ios/iphonesimulator
          zip -r ../../../../artifacts/agus-maps-ios-simulator.app.zip Runner.app
          ls -lh ../../../../artifacts/

      # ======================================================================
      # Build macOS Example App
      # ======================================================================
      - name: Setup macOS Pre-built XCFramework
        run: |
          mkdir -p macos/Frameworks
          cp -r build/agus-binaries-macos/CoMaps.xcframework macos/Frameworks/
          ls -la macos/Frameworks/

      - name: Precache macOS
        run: flutter precache --macos

      - name: Install macOS CocoaPods Dependencies
        run: |
          cd example/macos
          pod install

      - name: Build macOS Release App
        run: |
          cd example
          flutter build macos --release \
            --build-name=1.0.0 \
            --build-number=${{ github.run_number }}

      - name: Prepare macOS Artifact
        run: |
          cd example/build/macos/Build/Products/Release
          zip -r ../../../../../../artifacts/agus-maps-macos.app.zip agus_maps_flutter_example.app
          ls -lh ../../../../../../artifacts/

      # ======================================================================
      # Upload Mac Platforms Artifacts (for release job)
      # ======================================================================
      - name: Upload All Mac Platform Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-platforms-artifacts
          path: |
            build/agus-headers.tar.gz
            build/agus-binaries-android.zip
            build/agus-binaries-ios.zip
            build/agus-binaries-macos.zip
            artifacts/agus-maps-android.aab
            artifacts/agus-maps-android.apk
            artifacts/agus-maps-ios-simulator.app.zip
            artifacts/agus-maps-macos.app.zip
          retention-days: 7

  # ==========================================================================
  # Windows Job: Builds Windows (all in one job)
  # ==========================================================================
  build-windows-platform:
    name: Build Windows
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      # ======================================================================
      # Setup
      # ======================================================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Cache CoMaps Source
        id: cache-comaps
        uses: actions/cache@v4
        with:
          path: thirdparty/comaps
          key: comaps-source-${{ runner.os }}-${{ env.COMAPS_TAG }}
          restore-keys: |
            comaps-source-${{ runner.os }}-

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: C:\vcpkg
          key: vcpkg-windows-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-windows-

      - name: Setup vcpkg
        run: |
          if (-not (Test-Path "C:\vcpkg\vcpkg.exe")) {
            git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
            C:\vcpkg\bootstrap-vcpkg.bat
          }
          # Install zlib for Windows build (--classic bypasses manifest mode)
          C:\vcpkg\vcpkg.exe install zlib:x64-windows --classic
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      # ======================================================================
      # Bootstrap CoMaps
      # ======================================================================
      - name: Bootstrap CoMaps
        run: |
          .\scripts\bootstrap.ps1 -NoCache
        shell: pwsh

      # ======================================================================
      # Build Windows Native Libraries
      # ======================================================================
      - name: Build Windows Native Libraries
        run: |
          .\scripts\build_binaries_windows.ps1 -VcpkgRoot "C:\vcpkg"
          Get-ChildItem -Path build\agus-binaries-windows\ -Recurse
        shell: pwsh

      # ======================================================================
      # Build Windows Example App
      # ======================================================================
      - name: Setup Windows Pre-built DLLs
        run: |
          New-Item -ItemType Directory -Force -Path windows\prebuilt\x64
          Copy-Item -Path build\agus-binaries-windows\x64\* -Destination windows\prebuilt\x64\ -Force
          Get-ChildItem -Path windows\prebuilt\ -Recurse
        shell: pwsh

      - name: Get Flutter Dependencies
        run: |
          flutter pub get
          cd example
          flutter pub get

      - name: Build Windows Release App
        run: |
          cd example
          flutter build windows --release `
            --build-name=1.0.0 `
            --build-number=${{ github.run_number }}
        shell: pwsh

      - name: Prepare Windows Artifacts
        run: |
          New-Item -ItemType Directory -Force -Path artifacts
          $releasePath = "example\build\windows\x64\runner\Release"
          Compress-Archive -Path "$releasePath\*" -DestinationPath "artifacts\agus-maps-windows.zip" -Force
          Get-ChildItem -Path artifacts\
        shell: pwsh

      # ======================================================================
      # Upload Windows Artifacts (for release job)
      # ======================================================================
      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-platform-artifacts
          path: |
            build/agus-binaries-windows.zip
            artifacts/agus-maps-windows.zip
          retention-days: 7

  # ==========================================================================
  # Release Job: Publishes all artifacts to GitHub Releases
  # ==========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs:
      - build-mac-platforms
      - build-windows-platform
    if: ${{ always() && (needs.build-mac-platforms.result == 'success' || needs.build-mac-platforms.result == 'skipped') && needs.build-windows-platform.result == 'success' }}
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Mac Platforms Artifacts
        uses: actions/download-artifact@v4
        with:
          name: mac-platforms-artifacts
          path: release-assets/

      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-platform-artifacts
          path: release-assets/

      - name: Prepare Release Assets
        run: |
          echo "=== Release assets structure ==="
          find release-assets -type f
          
          # Flatten structure if needed
          mkdir -p final-assets
          find release-assets -name "*.tar.gz" -exec cp {} final-assets/ \;
          find release-assets -name "*.zip" -exec cp {} final-assets/ \;
          find release-assets -name "*.aab" -exec cp {} final-assets/ \;
          find release-assets -name "*.apk" -exec cp {} final-assets/ \;
          
          # Generate build info
          cat > final-assets/BUILD_INFO.txt << EOF
          Agus Maps Flutter - ${{ github.ref_name }}
          ==================================
          
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Build Number: ${{ github.run_number }}
          Git SHA: ${{ github.sha }}
          Git Tag: ${{ github.ref_name }}
          
          Flutter Version: ${{ env.FLUTTER_VERSION }}
          CoMaps Version: ${{ env.COMAPS_TAG }}
          
          Supported Platforms:
          - Android (armeabi-v7a, arm64-v8a, x86_64)
          - iOS (arm64 device + arm64/x86_64 simulator)
          - macOS (arm64 + x86_64 universal)
          - Windows (x64)
          EOF
          
          echo "=== Final assets ==="
          ls -lh final-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Agus Maps ${{ github.ref_name }}
          body: |
            ## Agus Maps Flutter - ${{ github.ref_name }}

            Offline vector maps for Flutter powered by the CoMaps engine.

            ðŸ“– **[Full Installation Guide](https://github.com/agus-works/agus-maps-flutter/blob/main/docs/RELEASE.md)**

            ---

            ### Quick Start

            #### Android (APK)
            ```bash
            # Via ADB
            adb install agus-maps-android.apk

            # Or download APK directly on device and tap to install
            ```

            #### iOS Simulator
            ```bash
            unzip agus-maps-ios-simulator.app.zip
            xcrun simctl install booted Runner.app
            xcrun simctl launch booted app.agus.maps.agus_maps_flutter_example
            ```

            #### macOS
            ```bash
            unzip agus-maps-macos.app.zip
            xattr -cr agus_maps_flutter_example.app  # Remove quarantine
            open agus_maps_flutter_example.app
            ```

            #### Windows
            ```powershell
            Expand-Archive agus-maps-windows.zip -DestinationPath .
            .\agus_maps_flutter_example.exe
            ```

            ---

            ### Downloads

            #### ðŸ“± Example Apps (Ready to Install)
            | Platform | File | Description |
            |----------|------|-------------|
            | Android | `agus-maps-android.apk` | Universal APK - install via ADB or directly |
            | Android | `agus-maps-android.aab` | App Bundle - for Play Store upload only |
            | iOS | `agus-maps-ios-simulator.app.zip` | Simulator only (debug, unsigned) |
            | macOS | `agus-maps-macos.app.zip` | Universal binary (release, unsigned) |
            | Windows | `agus-maps-windows.zip` | x64 release build |

            #### ðŸ“¦ Native Libraries (For Plugin Integration)
            | Platform | File | Description |
            |----------|------|-------------|
            | All | `agus-headers.tar.gz` | C++ headers for compilation |
            | iOS | `agus-binaries-ios.zip` | XCFramework (device + simulator) |
            | Android | `agus-binaries-android.zip` | Native .so libraries (arm64, armv7, x86_64) |
            | macOS | `agus-binaries-macos.zip` | XCFramework (arm64 + x86_64) |
            | Windows | `agus-binaries-windows.zip` | DLLs (x64) |

            ---

            ### Features
            - ðŸ—ºï¸ Offline vector maps powered by CoMaps/Organic Maps engine
            - ðŸŒ OpenStreetMap data with beautiful cartography
            - ðŸ”‹ Battery-efficient event-driven rendering
            - âš¡ Zero-copy GPU texture sharing (Metal on Apple, OpenGL ES on Android, WGL on Windows)
            - ðŸ“ Search, routing, and POI information

            ---

            ### Requirements
            - **Android**: API 24+ (Android 7.0+)
            - **iOS**: iOS 15.6+ (Simulator only for this build)
            - **macOS**: macOS 12.0+ (Monterey)
            - **Windows**: Windows 10+ (x64)

            ---

            ### Build Info
            - Build Number: ${{ github.run_number }}
            - Flutter: ${{ env.FLUTTER_VERSION }}
            - CoMaps: ${{ env.COMAPS_TAG }}
          draft: false
          prerelease: false
          files: |
            final-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
