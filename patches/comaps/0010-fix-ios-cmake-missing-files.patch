diff --git a/CMakeLists.txt b/CMakeLists.txt
index d0ecf6e..5c2c6de 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -22,7 +22,8 @@ if (POLICY CMP0156)
   cmake_policy(SET CMP0156 NEW)
 endif()
 
-set(OMIM_ROOT ${CMAKE_SOURCE_DIR})
+# Use CMAKE_CURRENT_SOURCE_DIR so this works when added as subdirectory
+set(OMIM_ROOT ${CMAKE_CURRENT_SOURCE_DIR})
 set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${OMIM_ROOT}/cmake")
 
 set(CMAKE_POSITION_INDEPENDENT_CODE ON)
@@ -83,6 +84,8 @@ endif()
 # Global compile options for all configurations.
 if (MSVC)
   add_compile_options(/utf-8)
+  # /bigobj needed for unity builds with many sections
+  add_compile_options(/bigobj)
   add_link_options(/INCREMENTAL:NO)
 else()
   add_compile_options(-ffast-math $<$<CXX_COMPILER_ID:GNU>:-Wno-psabi>)
@@ -96,7 +99,14 @@ if (PLATFORM_WIN)
 endif()
 
 # Built-in CMake configurations: Debug, Release, RelWithDebInfo, MinSizeRel
-if (${CMAKE_BUILD_TYPE} STREQUAL "Debug")
+# Use generator expressions for multi-config generators (Visual Studio, Xcode)
+if (CMAKE_CONFIGURATION_TYPES)
+  # Multi-config generator (Visual Studio, Xcode)
+  add_compile_definitions(
+    $<$<CONFIG:Debug>:DEBUG>
+    $<$<NOT:$<CONFIG:Debug>>:RELEASE>
+  )
+elseif (${CMAKE_BUILD_TYPE} STREQUAL "Debug")
   add_definitions(-DDEBUG)
   if (NOT MSVC)
     add_compile_options(-fno-omit-frame-pointer)
@@ -107,7 +117,8 @@ elseif (${CMAKE_BUILD_TYPE} MATCHES "Rel")
     add_compile_options(-O3 $<$<CXX_COMPILER_ID:GNU>:-flto=auto>)
   endif()
 else()
-  message(FATAL_ERROR "Unknown build type: " ${CMAKE_BUILD_TYPE})
+  message(WARNING "Unknown or empty build type: ${CMAKE_BUILD_TYPE}, defaulting to RELEASE")
+  add_definitions(-DRELEASE)
 endif()
 
 if (${CMAKE_BUILD_TYPE} STREQUAL "RelWithDebInfo")
@@ -150,7 +161,7 @@ find_package(Threads REQUIRED)
 
 # Scripts
 
-if (NOT PLATFORM_IPHONE AND NOT PLATFORM_ANDROID)
+if (NOT PLATFORM_IPHONE AND NOT PLATFORM_ANDROID AND NOT SKIP_QT)
   list(APPEND qt_components Core Network)
   if (NOT SKIP_QT_GUI OR NOT SKIP_TESTS OR PYBINDINGS)
     list(APPEND qt_components Widgets)
@@ -170,7 +181,8 @@ if (NOT PLATFORM_IPHONE AND NOT PLATFORM_ANDROID)
 endif()
 
 # To allow #include "base/file_name.hpp" in all sources.
-include_directories("${CMAKE_HOME_DIRECTORY}" "${CMAKE_HOME_DIRECTORY}/libs" "${CMAKE_HOME_DIRECTORY}/tools")
+# Use OMIM_ROOT instead of CMAKE_HOME_DIRECTORY so this works when added as subdirectory
+include_directories("${OMIM_ROOT}" "${OMIM_ROOT}/libs" "${OMIM_ROOT}/tools")
 
 if (USE_PCH)
   message(STATUS "Precompiled headers are ON")
@@ -200,6 +212,24 @@ endif()
 
 find_package(ZLIB REQUIRED)
 
+# Fix for #include <boost/regex.hpp>
+include_directories("${OMIM_ROOT}/3party/boost")
+
+# Boost modular headers - each module has its headers in libs/<module>/include/
+# This is required because boost uses a modular structure with headers split per-library
+# MUST be set BEFORE add_subdirectory(3party) so that succinct, opening_hours, etc. see these paths
+file(GLOB BOOST_LIBS_DIRS "${OMIM_ROOT}/3party/boost/libs/*/include")
+# Also handle nested modules like libs/numeric/conversion/include
+file(GLOB BOOST_NESTED_DIRS "${OMIM_ROOT}/3party/boost/libs/*/*/include")
+list(APPEND BOOST_LIBS_DIRS ${BOOST_NESTED_DIRS})
+if(BOOST_LIBS_DIRS)
+  include_directories(${BOOST_LIBS_DIRS})
+  # Export for external consumers (agus_maps_flutter library)
+  set(BOOST_INCLUDE_DIRS ${BOOST_LIBS_DIRS} PARENT_SCOPE)
+  list(LENGTH BOOST_LIBS_DIRS BOOST_LIBS_COUNT)
+  message(STATUS "Found ${BOOST_LIBS_COUNT} modular Boost include directories")
+endif()
+
 # Include 3party dependencies.
 add_subdirectory(3party)
 
@@ -209,38 +239,40 @@ if (PLATFORM_DESKTOP AND NOT WITH_SYSTEM_PROVIDED_3PARTY)
   include_directories("${PROJECT_BINARY_DIR}/3party/gflags/include")
 endif()
 
-# Fix for #include <boost/regex.hpp>
-include_directories("${OMIM_ROOT}/3party/boost")
-
-# Used in qt/ and shaders/
+# Python3 is used in shaders/ for shader preprocessing (all platforms)
 find_package(Python3 REQUIRED COMPONENTS Interpreter)
 
-execute_process(
-    COMMAND ${Python3_EXECUTABLE} -c "import google.protobuf; 
+# Protobuf check is only needed for desktop builds with Qt (generator tools)
+if (PLATFORM_DESKTOP AND NOT SKIP_QT)
+  execute_process(
+      COMMAND ${Python3_EXECUTABLE} -c "import google.protobuf; 
 print(google.protobuf.__version__)"
-    RESULT_VARIABLE PROTOBUF_CHECK
-    OUTPUT_VARIABLE PROTOBUF_VERSION
-    OUTPUT_STRIP_TRAILING_WHITESPACE
-    ERROR_QUIET
-)
-
-if(PROTOBUF_CHECK EQUAL 0)
-    if(PROTOBUF_VERSION VERSION_LESS "4.0.0")
-        message(STATUS "Python protobuf ${PROTOBUF_VERSION} found (< 4.0)")
-    else()
-        message(FATAL_ERROR "Python protobuf ${PROTOBUF_VERSION} found, but version < 4.0 required")
-    endif()
-else()
-    message(FATAL_ERROR "Python protobuf not found. Install version <4.0")
+      RESULT_VARIABLE PROTOBUF_CHECK
+      OUTPUT_VARIABLE PROTOBUF_VERSION
+      OUTPUT_STRIP_TRAILING_WHITESPACE
+      ERROR_QUIET
+  )
+
+  if(PROTOBUF_CHECK EQUAL 0)
+      if(PROTOBUF_VERSION VERSION_LESS "4.0.0")
+          message(STATUS "Python protobuf ${PROTOBUF_VERSION} found (< 4.0)")
+      else()
+          message(FATAL_ERROR "Python protobuf ${PROTOBUF_VERSION} found, but version < 4.0 required")
+      endif()
+  else()
+      message(FATAL_ERROR "Python protobuf not found. Install version <4.0")
+  endif()
 endif()
 
 
 add_subdirectory(libs)
 
 if (PLATFORM_DESKTOP)
-  add_subdirectory(dev_sandbox)
-  add_subdirectory(generator)
-  add_subdirectory(tools)
+  if (NOT SKIP_TOOLS)
+    add_subdirectory(dev_sandbox)
+    add_subdirectory(generator)
+    add_subdirectory(tools)
+  endif()
   if (NOT SKIP_QT_GUI)
     add_subdirectory(qt)
   endif()
@@ -252,6 +284,6 @@ endif()
 
 omim_add_test_subdirectory(libs/qt_tstfrm)
 
-if (PLATFORM_ANDROID)
+if (PLATFORM_ANDROID AND NOT SKIP_ANDROID_JNI)
   add_subdirectory(android/sdk/src/main/cpp)
 endif()
